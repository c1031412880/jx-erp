# 分公司材料领用报表

## 功能概述

分公司材料领用报表是一个专门用于统计和分析各分公司材料使用情况的报表功能。该报表以分公司为主维度，通过动态列头展示不同物料的使用数据，支持多仓库筛选、时间范围查询和数据导出功能。

**✅ 已完成 GetDeptLeave 接口对接**

## 接口对接详情

### 数据查询接口
- **接口名称**: `/api/ERPWeb/InventoryReport/GetDeptLeave`
- **接口方法**: `GetDeptLeaveInventoryReport`
- **请求方式**: POST

#### 请求参数结构
```javascript
{
  // server_id 已在 http.js 中自动处理，无需手动传递
  "context": {
    "start_time": "2025-01-01T00:00:00Z",  // ISO格式开始时间
    "end_time": "2025-01-31T23:59:59Z",    // ISO格式结束时间
    "house_ids": [1, 2, 3]                 // 仓库ID数组，[0]表示全部
  }
}
```

#### 响应数据结构
```javascript
{
  "head": {
    "cmd": "string",
    "result": "200",           // 成功状态码
    "describle": "string",     // 错误描述
    "detail": "string"
  },
  "context": {
    "heads": [                 // 动态列头配置（所有列都是动态的）
      {
        "name": "分公司",        // 列显示名称
        "data_symbol": "branchName"  // 数据字段名
      },
      {
        "name": "材料名称",      // 列显示名称
        "data_symbol": "material001"  // 数据字段名
      }
    ],
    "datas": [                // 表格数据（最后一行为合计数据）
      {
        "branchName": "一分公司",
        "material001": 100,
        "material002": 200
      },
      {
        "branchName": "二分公司",
        "material001": 150,
        "material002": 300
      },
      {
        "branchName": "合计",    // 最后一行为合计行
        "material001": 250,
        "material002": 500
      }
    ]
  },
  "file_id": "string"
}
```

### 数据导出接口
- **接口名称**: `/api/ERPWeb/InventoryReport/DeptLeaveExport`
- **接口方法**: `DeptLeaveExportInventoryReport`
- **请求方式**: POST

#### 导出参数结构
```javascript
{
  // server_id 已在 http.js 中自动处理，无需手动传递
  "context": {
    "start_time": "2025-01-01T00:00:00Z",
    "end_time": "2025-01-31T23:59:59Z",
    "house_ids": [1, 2, 3]
  }
}
```

## 主要功能特性

### 1. 查询功能 ✅
- **统计日期**：支持日期范围选择，默认为当前月份
- **仓库筛选**：支持多仓库选择，可同时选择多个仓库进行统计
- **参数验证**：完整的前端参数验证，确保数据有效性
- **智能重置**：一键重置所有查询条件至默认状态

### 2. 动态表格 ✅
- **全动态列头**：所有列都根据接口返回的 `heads` 数组动态生成，没有固定列
- **数据格式化**：数量自动添加千分位分隔符
- **内置合计行**：使用 tr-table 组件内置合计功能，自动处理合计数据显示
- **铺满显示**：去除边距，表格铺满整个屏幕，适配小屏幕设备
- **响应式设计**：自适应窗口大小变化，动态计算表格高度
- **智能对齐**：第一列左对齐，其他列右对齐

### 3. 数据导出 ✅
- **Excel导出**：支持将查询结果导出为Excel文件
- **条件传递**：导出时会传递当前查询条件
- **文件下载**：支持 `file_id` 和直接链接两种下载方式
- **状态控制**：只有查询到数据后才能进行导出

### 4. 错误处理 ✅
- **网络异常处理**：完善的网络请求异常捕获
- **数据异常处理**：对接口返回数据的完整性验证
- **用户友好提示**：详细的错误信息展示
- **降级处理**：异常情况下的数据清空和状态重置

## 数据处理流程

### 1. 查询数据流程
```
用户选择条件 → 参数验证 → 构建请求参数 → 调用GetDeptLeave接口 
→ 处理响应数据 → 构建动态列头 → 格式化表格数据 → 更新UI状态
```

### 2. 动态列头构建
- 根据接口返回的 `context.heads` 数组动态生成所有表格列配置
- 每个 `head` 对象包含 `name`（显示名称）和 `data_symbol`（数据字段）
- 自动设置列宽、对齐方式等属性（第一列左对齐，其他列右对齐）
- 没有固定列，所有列都是动态的

### 3. 数据格式化处理
- 数值类型自动添加千分位分隔符
- 空值统一处理为空字符串
- 最后一行数据自动分离为合计数据，通过 tr-table 内置合计功能显示
- 普通数据和合计数据分别处理，确保显示效果最佳

## 核心文件结构

```
branch-material-requisition/
├── index.vue                  # 主页面组件 ✅ 已对接GetDeptLeave接口
├── component/
│   └── sub-req.vue           # 查询条件组件 ✅ 已优化参数处理
└── README.md                 # 说明文档 ✅ 已更新接口对接说明
```

## 技术架构

### 前端框架
- **Vue.js 2.x**：基础框架
- **Element UI**：UI组件库
- **Stylus**：样式预处理器

### 核心技术特性
- **动态列渲染**：根据API返回的列配置动态生成表格列 ✅
- **响应式设计**：适配不同屏幕尺寸 ✅
- **错误处理**：完善的错误捕获和用户提示 ✅
- **加载状态**：优雅的加载状态管理 ✅
- **参数验证**：前端完整的参数验证机制 ✅

## API接口使用示例

### 查询数据
```javascript
// 调用方式（server_id已在http.js中自动处理）
this.$client.GetDeptLeaveInventoryReport({
  context: {
    start_time: "2025-01-01T00:00:00Z",
    end_time: "2025-01-31T23:59:59Z",
    house_ids: [1, 2, 3]
  }
})

// 成功响应处理
.then(response => {
  if (response.head.result === "200") {
    // 构建动态列头
    this.buildDynamicColumns(response.context.heads);
    // 处理表格数据
    this.processTableData(response.context.datas, response.context.heads);
  }
})
```

### 导出数据
```javascript
// 调用方式（server_id已在http.js中自动处理）
this.$client.DeptLeaveExportInventoryReport({
  context: {
    start_time: "2025-01-01T00:00:00Z",
    end_time: "2025-01-31T23:59:59Z",
    house_ids: [1, 2, 3]
  }
})

// 文件下载处理
.then(response => {
  if (response.head.result === "200") {
    if (response.file_id) {
      // 通过文件ID下载
      window.open(`/api/ERPWeb/Common/DownloadFile?fileId=${response.file_id}`);
    } else if (response.context) {
      // 直接链接下载
      window.location.href = response.context;
    }
  }
})
```

## 使用说明

### 基本操作流程
1. **页面加载**：系统自动设置当前月份为默认查询日期 ✅
2. **设置条件**：选择统计日期范围和仓库（可选）✅
3. **执行查询**：点击查询按钮获取数据 ✅
4. **查看结果**：在动态表格中查看统计结果 ✅
5. **导出数据**：如需要可点击导出按钮下载数据 ✅

### 高级功能
- **多仓库统计**：选择多个仓库进行综合统计分析 ✅
- **动态数据对比**：通过全动态表格快速对比各维度的数据情况 ✅
- **内置合计分析**：使用 tr-table 组件内置合计功能，自动计算和显示合计数据 ✅
- **小屏幕适配**：去除边距，表格铺满显示，完美适配移动设备和小屏幕 ✅
- **实时验证**：查询条件的实时验证和友好提示 ✅
- **智能布局**：flex 布局自适应，查询区域和表格区域合理分配空间 ✅

## 权限控制

- **菜单权限码**：`10032200`
- **功能权限**：需要具备材料管理模块的查看权限
- **数据权限**：根据用户权限显示对应的分公司和仓库数据

## 注意事项

### 性能优化 ✅
- 接口调用异常处理机制完善
- 动态列数量过多时会显示滚动条
- 数据导出时会有加载提示和状态控制

### 兼容性 ✅
- 支持现代浏览器（Chrome、Firefox、Safari、Edge）
- 响应式设计，支持移动端访问
- 兼容不同分辨率的显示设备

### 数据准确性 ✅
- 统计数据通过 GetDeptLeave 接口实时获取
- 支持按不同维度进行数据校验
- 异常数据会有相应的提示和处理

## 开发说明

### 接口对接状态 ✅
1. ✅ 已配置正确的API接口地址：`/api/ERPWeb/InventoryReport/GetDeptLeave`
2. ✅ 已调整数据结构以匹配实际业务数据
3. ✅ 已根据接口规范调整动态列配置
4. ✅ 已完成导出功能的接口对接

### 扩展功能
- 支持添加更多查询条件
- 支持不同的数据展示维度
- 支持图表可视化展示
- 支持数据钻取功能

## 更新日志

### v2.2.0 (2025-01-21) ✅ 当前版本
- **✅ 使用 tr-table 组件内置合计功能，替代自定义合计行处理**
- **✅ 去除报表边距，实现表格铺满显示以适配小屏幕**
- **✅ 优化布局为 flex 弹性布局，自适应屏幕大小**
- **✅ 改进表格高度计算逻辑，动态获取查询区域高度**
- **✅ 分离普通数据和合计数据处理逻辑**

### v2.1.0 (2025-01-21)
- **✅ 移除固定分公司列，实现全动态列头**
- **✅ 实现合计行特殊处理和样式突出显示**
- **✅ 优化列对齐方式（第一列左对齐，其他列右对齐）**
- **✅ 修复日期转换错误，完善日期处理安全性**
- **✅ 优化空值处理逻辑**

### v2.0.0 (2025-01-21)
- **✅ 完成 GetDeptLeave 接口对接**
- **✅ 实现动态列头根据接口返回数据构建**
- **✅ 完善错误处理和用户体验**
- **✅ 优化查询条件验证和状态管理**
- **✅ 实现导出功能的完整对接**
- **✅ 添加完整的接口文档和使用说明**

### v1.0.0 (2025-01-01)
- 实现基础的分公司材料统计功能
- 支持仓库多选和动态列头
- 添加数据导出功能
- 完善错误处理和用户体验

## 接口对接总结

本次对接已完成以下工作：

1. **✅ 接口调用**：成功集成 `/api/ERPWeb/InventoryReport/GetDeptLeave` 接口
2. **✅ 参数映射**：完成前端查询参数到接口参数的正确映射
3. **✅ 动态列头**：实现根据接口返回的 `heads` 数组动态构建表格列
4. **✅ 数据处理**：完成接口返回数据的格式化和展示
5. **✅ 错误处理**：实现完善的异常处理和用户提示机制
6. **✅ 导出功能**：完成导出接口的对接和文件下载处理
7. **✅ 状态管理**：优化组件间的状态同步和用户交互体验

接口对接工作已全部完成，可以正常使用！ 

## 最新修复内容

### 问题1: 合计数据错位
- **问题**: 合计数据显示错位，需要向后移一位
- **解决**: 在处理合计数据时，将索引 `index + 1` 向后移一位
- **代码位置**: `processTableData()` 方法中的合计数据处理部分

### 问题2: 仓库参数处理
- **问题**: 仓库没选择时需要传空数组
- **解决**: 确保 `house_ids` 在未选择时传递 `[]`
- **代码位置**: `loadData()` 方法中的参数构建

### 问题3: 报表高度计算
- **问题**: 一屏显示高度计算不准确
- **解决**: 
  - 参考 `material-receiving-and-sending-summary` 模块的高度计算方法
  - 使用 `this.$el.offsetHeight - this.$refs.head.$el.offsetHeight - 30` 计算
  - 简化计算逻辑，提高准确性和性能
- **代码位置**: `setHead()` 方法

### 问题4: 边距处理
- **问题**: 存在多余边距影响显示
- **解决**:
  - 参考 `material-receiving-and-sending-summary` 模块的样式设计
  - 使用简洁的 `width: 100%; height: 100%` 样式
  - 移除复杂的flex布局和强制边距设置
  - 让容器自然适配父级尺寸
- **代码位置**: 样式部分 